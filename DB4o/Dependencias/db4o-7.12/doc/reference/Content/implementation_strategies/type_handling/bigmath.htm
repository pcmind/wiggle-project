<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:lastBlockDepth="2" MadCap:lastHeight="120" MadCap:lastWidth="624" MadCap:disableMasterStylesheet="true" MadCap:tocPath="Implementation Strategies|Type Handling" MadCap:InPreviewMode="false" MadCap:RuntimeFileType="Topic" MadCap:TargetType="WebHelp" MadCap:PathToHelpSystem="../../../" MadCap:HelpSystemFileName="index.xml" MadCap:SearchType="Stem">
    <head><title>BigMath	</title>
        <script type="text/javascript">/* <![CDATA[ */
			window.onload = function(){
                             prettyPrint();
			};
                /* ]]> */</script>
        <link href="../../SkinSupport/MadCap.css" rel="stylesheet" />
        <link href="../../Resources/Stylesheets/OnlineStyle.css" rel="stylesheet" />
        <script src="../../Resources/Code/prettify.js">
        </script>
        <script src="../../Resources/Code/lang-vb.js">
        </script>
        <script src="../../SkinSupport/MadCapAll.js" type="text/javascript">
        </script>
    </head>
    <body>
        <p class="MCWebHelpFramesetLink" style="display: none;"><a href="../../../index_CSH.html#implementation_strategies/type_handling/bigmath.htm" style="">Open topic with navigation</a>
        </p>
        <div class="MCBreadcrumbsBox"><span class="MCBreadcrumbsPrefix">You are here: </span><a class="MCBreadcrumbsLink" href="../../implementation_strategies.htm">Implementation Strategies</a><span class="MCBreadcrumbsDivider"> &gt; </span><a class="MCBreadcrumbsLink" href="../type_handling.htm">Type Handling</a><span class="MCBreadcrumbsDivider"> &gt; </span><span class="MCBreadcrumbs">Bigmath</span>
        </div>
        <p>
            <script type="text/javascript">/*<![CDATA[*/document.write('<a href="' + location.href +'">');
				document.write("Direct Link");
			document.write('</a>');/*]]>*/</script>
        </p>
        <p>
        </p>
        <h1>BigMath</h1>
        <p>If you are dealing
with very big numbers, you might be using BigDecimal or BigInteger java classes.
These classes are specially designed to allow computations with of arbitrary
precision. Internally the values are stored in byte arrays for both types. Now,
thinking about it - it should not be a problem for db4o to store such values,
as it is just a matter of storing a class with the actual value in a byte array
field. However, a deeper consideration uncovers the following problems:</p>
        <ul>
            <li value="1">BigInteger/BigDecimal
     representation is different in different java versions, which can cause
     problems re-instantiating the objects from a database created with a
     different Java version. </li>
            <li value="2">BigDecimal relies on
     transient field setup in the constructor, which means that constructor use
     is compulsory</li>
            <li value="3">db4o would store instances
     of these classes as full object graphs: A BigDecimal contains a BigInteger
     which contains a byte array, plus some other fields. This graph would
     faithfully be persisted into the database file and it would have to be
     read and reconstructed on access - activation depth applies.</li>
            <li value="4">Querying and indexing will essentially
     be broken due to the above limitations.</li>
        </ul>
        <p>To see the problem you can try the following simple
test:</p>
        <pre class="prettyprint" xml:space="preserve">Probability.java
/**//* Copyright (C) 2004 - 2009  Versant Corporation http://www.versant.com */
package com.db4odoc.BigMath;

import java.math.*;

public class Probability  {
  // Using BigDecimal to represent very small probabilities
  BigDecimal value;
  
  public Probability(String sValue) {
    this.value = new BigDecimal(sValue);
  }
  
  public String toString() {
    return value.toString();
  }
}</pre>
        <pre class="prettyprint" xml:space="preserve">BigMathExample.java: testDefaultConfiguration
private static void testDefaultConfiguration()  {
    new File(DB4O_FILE_NAME).delete();
    ObjectContainer db = Db4oEmbedded.openFile(Db4oEmbedded
        .newConfiguration(), DB4O_FILE_NAME);
    Probability p1 = new Probability("2e-324");
    db.store(p1);
    p1 = new Probability("3e-324");
    db.store(p1);
    p1 = new Probability("4e-324");
    db.store(p1);
    db.close();

    db = Db4oEmbedded.openFile(Db4oEmbedded.newConfiguration(),
        DB4O_FILE_NAME);
    Query q = db.query();
    q.constrain(Probability.class);
    q.descend("value").constrain(new BigDecimal("3e-324")).greater();
    List&lt;Probability&gt; result = q.execute();
    for (Probability p : result)  {
      System.out.println(p);
    }
    db.close();
  }</pre>
        <p>You will see that comparison is not done correctly. However some of the queries can work fine, like unoptimized native queries for example. </p>
        <p>In order to solve the above mentioned problems db4o
implements special typehandlers for BigInteger and BigDecimal, which allow to
treat them as normal value types, i.e. in the same way as long and double, just
without precision limitation. These typehandlers are implemented in db4o
optional jar (required on the classpath) and should be added to the
configuration before opening the file with the following method:</p>
        <pre class="prettyprint" xml:space="preserve">BigMathExample.java: configBigMathSupport
private static EmbeddedConfiguration configBigMathSupport()  {
    EmbeddedConfiguration config = Db4oEmbedded.newConfiguration();
    config.common().add(new BigMathSupport());
    return config;
  }</pre>
        <p>Note, that BigMathSupport is a part of common
configuration interface and should be added through common() method.</p>
        <p>Now the initial example should produce expected
results:</p>
        <pre class="prettyprint" xml:space="preserve">BigMathExample.java: testBigMathConfiguration
private static void testBigMathConfiguration()  {
    new File(DB4O_FILE_NAME).delete();
    ObjectContainer db = Db4oEmbedded.openFile(configBigMathSupport(),
        DB4O_FILE_NAME);
    Probability p1 = new Probability("2e-324");
    db.store(p1);
    p1 = new Probability("3e-324");
    db.store(p1);
    p1 = new Probability("4e-324");
    db.store(p1);
    db.close();

    db = Db4oEmbedded.openFile(configBigMathSupport(), DB4O_FILE_NAME);
    Query q = db.query();
    q.constrain(Probability.class);
    q.descend("value").constrain(new BigDecimal("3e-324")).greater();
    List&lt;Probability&gt; result = q.execute();
    for (Probability p : result)  {
      System.out.println(p);
    }
    db.close();

  }</pre>
        <p MadCap:conditions="Primary.Online">Download example code:</p>
        <p MadCap:conditions="Primary.Online">
            <MadCap:conditionalText MadCap:conditions="Primary.Java"><a href="bigmathjava.zip">Java</a>
            </MadCap:conditionalText>
        </p>
        <script type="text/javascript" src="../../SkinSupport/MadCapBodyEnd.js">
        </script>
    </body>
</html>